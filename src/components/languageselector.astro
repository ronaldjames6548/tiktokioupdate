---
// src/components/LanguageSelector.astro
import { getCurrentLanguage } from "../utils/i18n";

interface Props {
  showFlag?: boolean;
  languageMapping?: Record<string, string>;
  class?: string;
}

const { 
  showFlag = true, 
  languageMapping = {},
  class: className = "appearance-none py-1 px-2 rounded bg-slate-100 dark:bg-stone-950"
} = Astro.props;

const currentLang = getCurrentLanguage(Astro.url);

const languages = [
  { code: 'en', name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
  { code: 'it', name: 'Italiano', flag: 'ðŸ‡®ðŸ‡¹' },
  { code: 'fr', name: 'FranÃ§ais', flag: 'ðŸ‡«ðŸ‡·' },
  { code: 'de', name: 'Deutsch', flag: 'ðŸ‡©ðŸ‡ª' },
  { code: 'es', name: 'EspaÃ±ol', flag: 'ðŸ‡ªðŸ‡¸' },
  { code: 'hi', name: 'à¤¹à¤¿à¤‚à¤¦à¥€', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ðŸ‡¸ðŸ‡¦' },
  { code: 'id', name: 'Bahasa Indonesia', flag: 'ðŸ‡®ðŸ‡©' },
  { code: 'ru', name: 'Ð ÑƒÑÑÐºÐ¸Ð¹', flag: 'ðŸ‡·ðŸ‡º' },
  { code: 'pt', name: 'PortuguÃªs', flag: 'ðŸ‡µðŸ‡¹' },
  { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ðŸ‡°ðŸ‡·' },
  { code: 'tl', name: 'Filipino', flag: 'ðŸ‡µðŸ‡­' },
  { code: 'nl', name: 'Nederlands', flag: 'ðŸ‡³ðŸ‡±' },
  { code: 'ms', name: 'Bahasa Melayu', flag: 'ðŸ‡²ðŸ‡¾' },
  { code: 'tr', name: 'TÃ¼rkÃ§e', flag: 'ðŸ‡¹ðŸ‡·' },
];

// Apply custom language mapping if provided
const mappedLanguages = languages.map(lang => ({
  ...lang,
  name: languageMapping[lang.code] || lang.name
}));

const currentLanguage = mappedLanguages.find(lang => lang.code === currentLang) || mappedLanguages[0];

// Get the current path without language prefix for switching
const currentPath = Astro.url.pathname.replace(/^\/[a-z]{2}(\/|$)/, '/');
---

<div class="relative" x-data="{ open: false }">
  <button
    @click="open = !open"
    @click.away="open = false"
    class={className}
  >
    {showFlag && <span class="text-lg mr-2">{currentLanguage.flag}</span>}
    <span class="text-sm font-medium">{currentLanguage.name}</span>
    <svg 
      class="w-4 h-4 ml-2 transition-transform inline" 
      :class="{ 'rotate-180': open }"
      fill="none" 
      stroke="currentColor" 
      viewBox="0 0 24 24"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>
  
  <div
    x-show="open"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100"
    x-transition:leave="transition ease-in duration-75"
    x-transition:leave-start="opacity-100 scale-100"
    x-transition:leave-end="opacity-0 scale-95"
    class="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50"
    style="display: none;"
  >
    <div class="py-1 max-h-60 overflow-y-auto">
      {mappedLanguages.map((language) => {
        const href = language.code === 'en' ? currentPath : `/${language.code}${currentPath}`;
        const isActive = language.code === currentLang;
        
        return (
          <a
            href={href}
            class={`flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${
              isActive ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400' : 'text-gray-700 dark:text-gray-300'
            }`}
          >
            {showFlag && <span class="mr-3 text-lg">{language.flag}</span>}
            <span class="flex-1">{language.name}</span>
            {isActive && (
              <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            )}
          </a>
        );
      })}
    </div>
  </div>
</div>