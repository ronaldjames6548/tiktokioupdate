---
import { getCollection } from "astro:content";
import Posts from "@components/blog/posts.astro";
import Container from "@components/container.astro";
import Sectionhead from "@components/sectionhead.astro";
import Layout from "@layouts/Layout.astro";
import { t } from "i18next";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => 
    !data.draft && data.publishDate < new Date()
  );
  
  const languages = "en", "it", "fr", "de", "es", "hi", "ar", "id", "ru", "pt", "ko", "tl", "nl", "ms", "tr"];

  return languages.flatMap(lang => {
    const langPosts = posts.filter(post => post.slug.startsWith(`${lang}/`));
    const tags = new Set();
    
    langPosts.forEach(post => {
      post.data.tags?.forEach(tag => tags.add(tag.toLowerCase()));
    });

    return Array.from(tags).map(tag => ({
      params: { tag, lang },
      props: {
        posts: langPosts.filter(post => 
          post.data.tags?.some(t => t.toLowerCase() === tag)
        ),
        tag,
        lang
      }
    }));
  });
}

const { posts = [], tag, lang } = Astro.props;
if (!tag) return new Response(null, { status: 404 });
---

<Layout 
  title={`${t("mics.tag_title1")} ${tag} ${t("mics.tag_title2")}`} 
  lang={lang}
>
  <Container>
    <Sectionhead>
      <Fragment slot="title">
        {`${t("mics.tag_title1")} ${tag} ${t("mics.tag_title2")}`}
      </Fragment>
      <Fragment slot="desc">
        {`${t("mics.tag_desc")} ${tag} ${t("mics.tag_desc2")}`}
      </Fragment>
    </Sectionhead>
    <Posts posts={posts} />
  </Container>
</Layout>